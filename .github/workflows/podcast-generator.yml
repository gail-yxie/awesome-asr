name: Daily Podcast Generator

on:
  # schedule:
  #   - cron: '0 8 * * *'  # Migrated to Cloud Run Jobs + Cloud Scheduler
  workflow_dispatch:       # Manual trigger (emergency fallback)

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Install Python dependencies
        run: pip install -r requirements.txt soundfile

      - name: Generate podcast script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python -m scripts.podcast.script_generator

      - name: Generate podcast audio
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: python -m scripts.podcast.tts_engine

      - name: Set day tag
        run: echo "DAY_TAG=$(date +%Y-%m-%d)" >> $GITHUB_ENV

      - name: Upload podcast to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: podcast-${{ env.DAY_TAG }}
          name: "ASR Podcast â€” ${{ env.DAY_TAG }}"
          files: podcasts/*.mp3
          body: "Auto-generated daily ASR podcast episode."

      - name: Update podcast index
        run: |
          DAY_TAG="${{ env.DAY_TAG }}"
          REPO="${{ github.repository }}"
          MP3_URL="https://github.com/${REPO}/releases/download/podcast-${DAY_TAG}/${DAY_TAG}.mp3"

          # Create or update podcasts/index.md
          if [ ! -f podcasts/index.md ]; then
            echo "# ASR Podcast Episodes" > podcasts/index.md
            echo "" >> podcasts/index.md
            echo "| Episode | Date | Audio |" >> podcasts/index.md
            echo "|---------|------|-------|" >> podcasts/index.md
          fi

          echo "| ${DAY_TAG} | $(date +%Y-%m-%d) | [Listen](${MP3_URL}) |" >> podcasts/index.md

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add podcasts/
          git diff --cached --quiet || git commit -m "podcast: Add episode for $(date +%Y-%m-%d)"
          git push
